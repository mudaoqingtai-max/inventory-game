<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Tetris</title>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            font-family: 'Arial', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
            overflow: hidden;
        }

        h1 { font-size: 20px; margin: 10px; }
        #score-board { font-size: 18px; margin-bottom: 10px; color: #f1c40f; }

        /* ã‚«ãƒãƒ³ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            background-color: #34495e;
            padding: 5px;
            border-radius: 8px;
            border: 4px solid #95a5a6;
            touch-action: none;
        }

        .cell {
            width: 45px;
            height: 45px;
            background-color: #2c3e50;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        .cell.filled { background-color: #3e2723; box-shadow: inset 0 0 10px #000; }
        .cell.highlight { background-color: rgba(46, 204, 113, 0.5); } /* é…ç½®äºˆæ¸¬ */
        .cell.invalid { background-color: rgba(231, 76, 60, 0.5); } /* ç½®ã‘ãªã„æ™‚ */

        /* ã‚¢ã‚¤ãƒ†ãƒ ç½®ãå ´ */
        #spawner {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            height: 100px;
            align-items: center;
        }

        .item-preview {
            display: grid;
            gap: 1px;
            cursor: grab;
            touch-action: none;
            transition: transform 0.1s;
        }
        
        .item-cell {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            border-radius: 2px;
            color: white;
            font-weight: bold;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .dragging {
            position: fixed;
            pointer-events: none; /* ä¸‹ã®è¦ç´ ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã«å¿…è¦ */
            z-index: 1000;
            opacity: 0.9;
            transform: scale(1.5); /* æŒ‡ã§éš ã‚Œãªã„ã‚ˆã†ã«å°‘ã—å¤§ãã */
        }

        #game-over {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        button {
            padding: 15px 30px;
            font-size: 20px;
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>ğŸ’ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªæ•´ç†</h1>
    <div id="score-board">Score: 0</div>

    <div id="grid-container"></div>

    <div id="spawner">
        </div>

    <div id="game-over">
        <h2 style="color: #e74c60;">Inventory Full!</h2>
        <button onclick="resetGame()">Retry</button>
    </div>

<script>
    // --- è¨­å®š ---
    const COLS = 6;
    const ROWS = 8;
    const gridContainer = document.getElementById('grid-container');
    const spawner = document.getElementById('spawner');
    const scoreBoard = document.getElementById('score-board');
    let grid = []; // 0:ç©º, 1:åŸ‹ã¾ã‚Š
    let score = 0;
    
    // ã‚¢ã‚¤ãƒ†ãƒ å®šç¾©ï¼ˆå½¢ã¨è‰²ã¨çµµæ–‡å­—ï¼‰
    const ITEMS = [
        { shape: [[1]], color: '#e74c3c', icon: 'ğŸ' }, // ã‚Šã‚“ã”ï¼ˆ1ãƒã‚¹ï¼‰
        { shape: [[1],[1]], color: '#3498db', icon: 'ğŸ—¡ï¸' }, // å‰£ï¼ˆç¸¦2ï¼‰
        { shape: [[1,1]], color: '#3498db', icon: 'ğŸ—¡ï¸' }, // å‰£ï¼ˆæ¨ª2ï¼‰
        { shape: [[1,1],[1,1]], color: '#f1c40f', icon: 'ğŸ›¡ï¸' }, // ç›¾ï¼ˆ2x2ï¼‰
        { shape: [[1,0],[1,1]], color: '#9b59b6', icon: 'ğŸ”®' }, // Lå­—
        { shape: [[0,1],[1,1]], color: '#2ecc71', icon: 'ğŸŒ¿' }, // é€†Lå­—
        { shape: [[1,1,1]], color: '#ecf0f1', icon: 'ğŸ¥–' }, // ãƒ‘ãƒ³ï¼ˆæ¨ª3ï¼‰
    ];

    // --- åˆæœŸåŒ– ---
    function init() {
        grid = Array(ROWS).fill().map(() => Array(COLS).fill(null));
        score = 0;
        updateScore();
        renderGrid();
        spawnItem();
        spawnItem();
        spawnItem();
    }

    function renderGrid() {
        gridContainer.innerHTML = '';
        grid.forEach((row, y) => {
            row.forEach((cell, x) => {
                const div = document.createElement('div');
                div.classList.add('cell');
                div.dataset.x = x;
                div.dataset.y = y;
                if (cell) {
                    div.classList.add('filled');
                    div.style.backgroundColor = cell.color; // èƒŒæ™¯è‰²
                    div.textContent = cell.icon; // çµµæ–‡å­—
                }
                gridContainer.appendChild(div);
            });
        });
    }

    // --- ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ ---
    function spawnItem() {
        if (spawner.children.length >= 3) return;

        const type = ITEMS[Math.floor(Math.random() * ITEMS.length)];
        const el = document.createElement('div');
        el.classList.add('item-preview');
        // ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å½¢ã‚’ä½œã‚‹
        el.style.gridTemplateColumns = `repeat(${type.shape[0].length}, 1fr)`;
        
        type.shape.forEach(row => {
            row.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.classList.add('item-cell');
                if (cell) {
                    cellDiv.style.backgroundColor = type.color;
                    cellDiv.textContent = type.icon;
                } else {
                    cellDiv.style.opacity = 0; // ç©ºç™½éƒ¨åˆ†
                }
                el.appendChild(cellDiv);
            });
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
        addDragLogic(el, type);
        spawner.appendChild(el);
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ ---
    function addDragLogic(element, itemData) {
        let isDragging = false;
        let clone = null;
        let startX, startY;

        const startDrag = (e) => {
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            isDragging = true;
            
            // ã‚¿ãƒƒãƒã‹ãƒã‚¦ã‚¹ã‹ã®åˆ¤å®š
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // ãƒ‰ãƒ©ãƒƒã‚°ç”¨ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ
            clone = element.cloneNode(true);
            clone.classList.add('dragging');
            // å…ƒã®è¦ç´ ã¨åŒã˜ã‚µã‚¤ã‚ºã«ã™ã‚‹
            clone.style.width = element.offsetWidth + 'px';
            clone.style.height = element.offsetHeight + 'px';
            
            document.body.appendChild(clone);
            moveAt(clientX, clientY);

            // å…ƒã®è¦ç´ ã‚’ä¸€æ™‚çš„ã«è¦‹ãˆãªãã™ã‚‹
            element.style.opacity = '0.3';
        };

        const moveAt = (x, y) => {
            if(!clone) return;
            // æŒ‡ã®å°‘ã—ä¸Šã«è¡¨ç¤ºï¼ˆè¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
            clone.style.left = x - clone.offsetWidth / 2 + 'px';
            clone.style.top = y - clone.offsetHeight / 2 - 50 + 'px'; 
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
            highlightGrid(x, y - 50, itemData.shape);
        };

        const onMove = (e) => {
            if (!isDragging) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            moveAt(clientX, clientY);
        };

        const endDrag = (e) => {
            if (!isDragging) return;
            isDragging = false;

            // ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã®åˆ¤å®š
            // æœ€å¾Œã«ã‚¿ãƒƒãƒã—ã¦ã„ãŸä½ç½®ã‚’å–å¾—
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY; // æŒ‡ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè€ƒæ…®

            const dropSuccess = tryPlaceItem(clientX, clientY - 50, itemData);

            if (dropSuccess) {
                element.remove(); // å…ƒã®è¦ç´ ã‚’å‰Šé™¤
                spawnItem(); // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ è£œå……
                checkLines(); // ãƒ©ã‚¤ãƒ³åˆ¤å®š
                checkGameOver(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
            } else {
                element.style.opacity = '1'; // å…ƒã«æˆ»ã™
            }

            if(clone) clone.remove();
            clearHighlight();
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ² (ãƒã‚¦ã‚¹ & ã‚¿ãƒƒãƒ)
        element.addEventListener('mousedown', startDrag);
        element.addEventListener('touchstart', startDrag, {passive: false});

        document.addEventListener('mousemove', onMove);
        document.addEventListener('touchmove', onMove, {passive: false});

        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    // --- ã‚°ãƒªãƒƒãƒ‰åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    function getGridPos(x, y) {
        // ç”»é¢ä¸Šã®åº§æ¨™ã‹ã‚‰ã‚°ãƒªãƒƒãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(x,y)ã‚’è¨ˆç®—
        // ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã®ä½ç½®æƒ…å ±ã‚’å–å¾—
        const rect = gridContainer.getBoundingClientRect();
        
        // ç¯„å›²å¤–ãªã‚‰null
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) return null;

        const cellSize = rect.width / COLS;
        const col = Math.floor((x - rect.left) / cellSize);
        const row = Math.floor((y - rect.top) / cellSize);

        // ãƒãƒƒãƒ•ã‚¡ã‚’æŒãŸã›ã¦æ­£ç¢ºãªãƒã‚¹ã‚’è¿”ã™
        if (col >= 0 && col < COLS && row >= 0 && row < ROWS) {
            return { c: col, r: row };
        }
        return null;
    }

    function tryPlaceItem(screenX, screenY, itemData) {
        // ã‚¢ã‚¤ãƒ†ãƒ ã®ä¸­å¿ƒä½ç½®åŸºæº–ã§åˆ¤å®š
        const pos = getGridPos(screenX, screenY);
        if (!pos) return false;

        // é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        // itemData.shapeã®ä¸­å¿ƒã‚’posã«åˆã‚ã›ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå·¦ä¸ŠåŸºæº–ã«ã™ã‚‹ï¼‰
        // è£œæ­£: ã‚¢ã‚¤ãƒ†ãƒ ã®å½¢çŠ¶ã®å¹…/2ã‚’å¼•ã„ã¦å·¦ä¸Šã‚’åˆã‚ã›ã‚‹è¨ˆç®—ãŒå¿…è¦ã ãŒã€
        // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ŒæŒ‡ã®ã‚ã‚‹å ´æ‰€ï¼ã‚¢ã‚¤ãƒ†ãƒ ã®å·¦ä¸Šã®ãƒã‚¹ã€ã¨ã™ã‚‹
        
        const startC = pos.c - Math.floor(itemData.shape[0].length / 2); 
        const startR = pos.r - Math.floor(itemData.shape.length / 2);

        // ãƒã‚§ãƒƒã‚¯
        for (let r = 0; r < itemData.shape.length; r++) {
            for (let c = 0; c < itemData.shape[r].length; c++) {
                if (itemData.shape[r][c] === 1) {
                    const targetC = startC + c;
                    const targetR = startR + r;
                    // æ å¤–ã¾ãŸã¯æ—¢ã«åŸ‹ã¾ã£ã¦ã„ã‚‹å ´åˆ
                    if (targetC < 0 || targetC >= COLS || targetR < 0 || targetR >= ROWS || grid[targetR][targetC]) {
                        return false;
                    }
                }
            }
        }

        // é…ç½®ç¢ºå®š
        for (let r = 0; r < itemData.shape.length; r++) {
            for (let c = 0; c < itemData.shape[r].length; c++) {
                if (itemData.shape[r][c] === 1) {
                    grid[startR + r][startC + c] = { color: itemData.color, icon: itemData.icon };
                }
            }
        }
        renderGrid();
        return true;
    }

    // --- ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º ---
    function highlightGrid(screenX, screenY, shape) {
        clearHighlight();
        const pos = getGridPos(screenX, screenY);
        if (!pos) return;

        const startC = pos.c - Math.floor(shape[0].length / 2);
        const startR = pos.r - Math.floor(shape.length / 2);
        let isValid = true;
        let cellsToHighlight = [];

        // ã¾ãšé…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        for (let r = 0; r < shape.length; r++) {
            for (let c = 0; c < shape[r].length; c++) {
                if (shape[r][c] === 1) {
                    const targetC = startC + c;
                    const targetR = startR + r;
                    if (targetC < 0 || targetC >= COLS || targetR < 0 || targetR >= ROWS || grid[targetR][targetC]) {
                        isValid = false;
                    } else {
                        // ã‚°ãƒªãƒƒãƒ‰å†…ã®DOMè¦ç´ ã‚’æ¢ã™
                        const index = targetR * COLS + targetC;
                        if(gridContainer.children[index]) cellsToHighlight.push(gridContainer.children[index]);
                    }
                }
            }
        }

        cellsToHighlight.forEach(el => {
            el.classList.add(isValid ? 'highlight' : 'invalid');
        });
    }

    function clearHighlight() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(c => {
            c.classList.remove('highlight');
            c.classList.remove('invalid');
        });
    }

    // --- ãƒ©ã‚¤ãƒ³æ¶ˆå» & ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ---
    function checkLines() {
        // æ¨ªä¸€åˆ—
        for (let r = ROWS - 1; r >= 0; r--) {
            if (grid[r].every(cell => cell !== null)) {
                grid.splice(r, 1);
                grid.unshift(Array(COLS).fill(null));
                score += 100;
                r++; // è½ã¡ã¦ããŸè¡Œã‚’å†ãƒã‚§ãƒƒã‚¯
            }
        }
        // ç¸¦ä¸€åˆ— (ç°¡æ˜“å®Ÿè£…ï¼šä»Šå›ã¯æ¨ªã®ã¿ã§ã‚‚ååˆ†é¢ç™½ã„ãŒã€ç¸¦ã‚‚å®Ÿè£…)
        for (let c = 0; c < COLS; c++) {
            let isColFull = true;
            for (let r = 0; r < ROWS; r++) {
                if (!grid[r][c]) isColFull = false;
            }
            if (isColFull) {
                for (let r = 0; r < ROWS; r++) grid[r][c] = null; // åˆ—ã‚’æ¶ˆã™
                score += 100;
            }
        }
        
        // éš™é–“è©°ã‚ï¼ˆé‡åŠ›ï¼‰ã¯ä»Šå›ã¯ç„¡ã—ï¼ˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãªã®ã§ï¼‰
        // ãã®ã¾ã¾æå†™æ›´æ–°
        updateScore();
        renderGrid();
    }

    function checkGameOver() {
        // ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ãŒã©ã“ã«ã‚‚ç½®ã‘ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ã¯é‡ã„ã®ã§
        // ç°¡æ˜“çš„ã«ã€Œç©ºããƒã‚¹ãŒæ¥µç«¯ã«å°‘ãªã„ã€ãªã©ã§åˆ¤å®šã™ã‚‹ã‹ã€
        // æœ¬æ ¼çš„ã«ã‚„ã‚‹ãªã‚‰å…¨æ¢ç´¢ã€‚ã“ã“ã§ã¯æœªå®Ÿè£…ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆ¤æ–­ã«å§”ã­ã‚‹ï¼‰
        // â€»è¦æœ›ãŒã‚ã‚Œã°ã€Œè©°ã¿åˆ¤å®šã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™
    }
    
    function resetGame() {
        document.getElementById('game-over').style.display = 'none';
        spawner.innerHTML = '';
        init();
    }

    function updateScore() {
        scoreBoard.textContent = `Score: ${score}`;
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    init();

</script>
</body>
</html>
